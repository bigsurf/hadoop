{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Create an Amazon EC2 instance running Hadoop.",
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Default": "dev",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
    },
    "PlacementGroup": {
      "Description": "Create in Placement Group",
      "Type": "String",
      "Default" : "false",
      "AllowedValues": [
        "true",
        "false"
      ],
      "ConstraintDescription": "Select true if you want to create it in a placement group."
    },
    "PlacementGroupName": {
      "Description": "Create in Placement Group",
      "Type": "String",
      "Default" : "false",
      "ConstraintDescription": "Created by placement_group.cform"
    },
    "SubnetId": {
      "Description": "Target Private SubnetId where the Hadoop instances will be launched",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "InstanceType": {
      "Description": "WebServer EC2 instance type",
      "Type": "String",
      "Default": "d2.4xlarge",
      "AllowedValues": [
        "c3.large",
        "c3.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "d2.xlarge",
        "d2.2xlarge",
        "d2.4xlarge",
        "d2.8xlarge"
      ],
      "ConstraintDescription": "must be a valid EC2 instance type."
    },
    "HadoopBucketName": {
      "Description": "Hadooop S3 bucket name",
      "Type": "String",
      "Default": "dev-msv-hadoop-data-001"
    },
    "HadoopInstanceSecurityGroupId": {
      "Type": "List<AWS::EC2::SecurityGroup::Id>",
      "Description": "HadoopSecurityGroup created in VPC template"
    },
    "AmbariPrivateDns": {
      "Type": "String",
      "Description": "Ambari server private DNS"
    }
  },

  "Mappings": {
    "RegionalAMIs" : {
      "us-east-1"        : {"Hadoop" : "ami-5328fe38"},
      "us-west-2"        : {"Hadoop" : "ami-0ff3f13f"},
      "us-west-1"        : {"Hadoop" : "ami-498a780d"},
      "eu-west-1"        : {"Hadoop" : "ami-74d29c03"},
      "eu-central-1"     : {"Hadoop" : "ami-8c96ac91"},
      "ap-northeast-1"   : {"Hadoop" : "ami-74379d74"},
      "ap-northeast-2"   : {"Hadoop" : "ami-18cc0276"},
      "ap-southeast-1"   : {"Hadoop" : "ami-f6edeea4"},
      "ap-southeast-2"   : {"Hadoop" : "ami-7b0d4b41"},
      "sa-east-1"        : {"Hadoop" : "ami-d5d35cc8"}
    }
  },

  "Conditions" : {
    "is_c1_medium" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "c1.medium" ]
    },
    "is_c1_xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "c1.xlarge" ]
    },
    "is_c3_large" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "c3.large" ]
    },
    "is_c3_xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "c3.xlarge" ]
    },
    "is_c3_2xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "c3.2xlarge" ]
    },
    "is_c3_4xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "c3.4xlarge" ]
    },
    "is_c3_8xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "c3.8xlarge" ]
    },
    "is_cc2_8xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "cc2.8xlarge" ]
    },
    "is_cg1_4xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "cg1.4xlarge" ]
    },
    "is_cr1_8xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "cr1.8xlarge" ]
    },
    "is_d2_xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "d2.xlarge" ]
    },
    "is_d2_2xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "d2.2xlarge" ]
    },
    "is_d2_4xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "d2.4xlarge" ]
    },
    "is_d2_8xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "d2.8xlarge" ]
    },
    "is_g2_2xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "g2.2xlarge" ]
    },
    "is_g2_8xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "g2.8xlarge" ]
    },
    "is_hi1_4xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "hi1.4xlarge" ]
    },
    "is_hs1_8xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "hs1.xlarge" ]
    },
    "is_i2_xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "i2.xlarge" ]
    },
    "is_i2_2xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "i2.2xlarge" ]
    },
    "is_i2_4xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "i2.4xlarge" ]
    },
    "is_i2_8xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "i2.8xlarge" ]
    },
    "is_m1_small" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m1.small" ]
    },
    "is_m1_medium" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m1.medium" ]
    },
    "is_m1_large" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m1.large" ]
    },
    "is_m1_xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m1.xlarge" ]
    },
    "is_m2_xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m2.xlarge" ]
    },
    "is_m2_2xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m2.2xlarge" ]
    },
    "is_m2_4xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m2.4xlarge" ]
    },
    "is_m3_medium" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m3.medium" ]
    },
    "is_m3_large" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m3.large" ]
    },
    "is_m3_xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m3.xlarge" ]
    },
    "is_m3_2xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "m3.2xlarge" ]
    },
    "is_r3_large" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "r3.large" ]
    },
    "is_r3_xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "r3.xlarge" ]
    },
    "is_r3_2xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "r3.2xlarge" ]
    },
    "is_r3_4xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "r3.4xlarge" ]
    },
    "is_r3_8xlarge" : {
      "Fn::Equals" : [ {
        "Ref" : "InstanceType"
      }, "r3.8xlarge" ]
    },
    "UsePlacementGroup" : { "Fn::Equals" : [ {"Ref" : "PlacementGroup"}, "true" ] },
    "NotUsePlacementGroup" : { "Fn::Equals" : [ {"Ref" : "PlacementGroup"}, "false" ] }  
  },

  "Resources": {
    "HadoopInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "HadoopInstancePolicy",
            "PolicyDocument": {
              "Statement": [
                {
                  "Sid": "BucketObjectAccess",
                  "Effect": "Allow",
                  "Action": [
                    "s3:Get*",
                    "s3:List*"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:s3:::",
                        {
                          "Ref": "HadoopBucketName"
                        },
                        "/*"
                      ]
                    ]
                  }
                },
                {
                  "Sid": "BucketAccess",
                  "Effect": "Allow",
                  "Action": [
                    "s3:Get*",
                    "s3:List*"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:s3:::",
                        {
                          "Ref": "HadoopBucketName"
                        }
                      ]
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "HadoopInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "HadoopInstanceRole"
          }
        ]
      }
    },
    "EC2InstanceWithoutPlacementGroup": {
      "Type": "AWS::EC2::Instance",
      "Condition" : "NotUsePlacementGroup",
      "Properties": {
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "SecurityGroupIds": {
          "Ref": "HadoopInstanceSecurityGroupId"
        },
        "SubnetId": {
          "Ref": "SubnetId"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "ImageId": {
          "Fn::FindInMap": [
            "RegionalAMIs",
            {
              "Ref": "AWS::Region"
            },
            "Hadoop"
          ]
        },
        "IamInstanceProfile": { "Ref": "HadoopInstanceProfile" },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::Region"
                  },
                  {
                    "Ref": "AWS::StackName"
                  },
                  "-ec2"
                ]
              ]
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -xe\n",
                "chkconfig ntpd on\n",
                "service ntpd start\n",
                "echo 'umask 022' > /etc/profile.d/umask.sh\n",
                "setenforce 0\n",
                "sed -i 's/^SELINUX=.*$/SELINUX=permissive/' /etc/selinux/config\n",
                "cd /tmp && curl -O https://bootstrap.pypa.io/get-pip.py && python get-pip.py && pip install awscli\n",
                "cd /etc/yum.repos.d && wget http://public-repo-1.hortonworks.com/ambari/centos6/2.x/updates/2.2.0.0/ambari.repo\n",
                "test -f /sys/kernel/mm/transparent_hugepage/enabled && echo never > /sys/kernel/mm/redhat_transparent_hugepage/enabled\n",
                "test -f /sys/kernel/mm/transparent_hugepage/defrag && echo never > /sys/kernel/mm/redhat_transparent_hugepage/defrag\n",
                "yum install ambari-agent -y\n",
                "ebs_i=0; BEGIN_TIME=`date +%s`\n",
                "while read DISK; do\n",
                "ebs_i=`expr $ebs_i + 1`; mkdir -p /hadoop$ebs_i; chmod 755 /hadoop$ebs_i\n",
                "( mkfs -t ext4 /dev/${DISK} && mount /dev/${DISK} /hadoop$ebs_i && chmod 777 /hadoop$ebs_i ) 2>&1 >>/var/log/userdata.log &\n",
                "done <<< \"$( lsblk | sed '1,3d' | cut -d' ' -f1 )\"\n",
                "echo Number of disks to be used for Hadoop: $ebs_i\n",
                "while [ $( ls -ld /hadoop* | grep '^.rwxrwxrwx' | wc -l ) -lt $ebs_i ]; do\n",
                "sleep 1; echo Number of disks ready: $( ls -ld /hadoop* | grep '^.rwxrwxrwx' | wc -l )\n",
                "done\n",
                "END_TIME=`date +%s`; echo Disk formatting and mounting took $( expr $END_TIME - $BEGIN_TIME ) seconds\n",
                "sed -i -e 's/^hostname=.*$/hostname=",
                {
                  "Ref": "AmbariPrivateDns"
                },
                "/' -e 's/^run_as_user=.*$/run_as_user=ec2-user/' /etc/ambari-agent/conf/ambari-agent.ini\n",
                "ambari-agent start\n"
              ]
            ]
          }
        },
        "BlockDeviceMappings": {
          "Fn::If": [
            "is_d2_4xlarge",
            [
              {
                "DeviceName": "/dev/sda1",
                "Ebs": {
                  "DeleteOnTermination": "true",
                  "VolumeSize": "32",
                  "VolumeType": "gp2"
                }
              },
              {
                "DeviceName": "/dev/xvdb",
                "VirtualName": "ephemeral0"
              },
              {
                "DeviceName": "/dev/xvdc",
                "VirtualName": "ephemeral1"
              },
              {
                "DeviceName": "/dev/xvdd",
                "VirtualName": "ephemeral2"
              },
              {
                "DeviceName": "/dev/xvde",
                "VirtualName": "ephemeral3"
              },
              {
                "DeviceName": "/dev/xvdf",
                "VirtualName": "ephemeral4"
              },
              {
                "DeviceName": "/dev/xvdg",
                "VirtualName": "ephemeral5"
              },
              {
                "DeviceName": "/dev/xvdh",
                "VirtualName": "ephemeral6"
              },
              {
                "DeviceName": "/dev/xvdi",
                "VirtualName": "ephemeral7"
              },
              {
                "DeviceName": "/dev/xvdj",
                "VirtualName": "ephemeral8"
              },
              {
                "DeviceName": "/dev/xvdk",
                "VirtualName": "ephemeral9"
              },
              {
                "DeviceName": "/dev/xvdl",
                "VirtualName": "ephemeral10"
              },
              {
                "DeviceName": "/dev/xvdm",
                "VirtualName": "ephemeral11"
              }
            ],
            {
              "Fn::If": [
                "is_m3_xlarge",
                [
                  {
                    "DeviceName": "/dev/sda1",
                    "Ebs": {
                      "DeleteOnTermination": "true",
                      "VolumeSize": "32",
                      "VolumeType": "gp2"
                    }
                  },
                  {
                    "DeviceName": "/dev/xvdb",
                    "VirtualName": "ephemeral0"
                  },
                  {
                    "DeviceName": "/dev/xvdc",
                    "VirtualName": "ephemeral1"
                  }
                ],
                {
                  "Fn::If": [
                    "is_m2_2xlarge",
                    [
                      {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                          "DeleteOnTermination": "true",
                          "VolumeSize": "32",
                          "VolumeType": "gp2"
                        }
                      },
                      {
                        "DeviceName": "/dev/xvdb",
                        "VirtualName": "ephemeral0"
                      }
                    ],
                    {
                      "Fn::If": [
                        "is_i2_8xlarge",
                        [
                          {
                            "DeviceName": "/dev/sda1",
                            "Ebs": {
                              "DeleteOnTermination": "true",
                              "VolumeSize": "32",
                              "VolumeType": "gp2"
                            }
                          },
                          {
                            "DeviceName": "/dev/xvdb",
                            "VirtualName": "ephemeral0"
                          },
                          {
                            "DeviceName": "/dev/xvdc",
                            "VirtualName": "ephemeral1"
                          },
                          {
                            "DeviceName": "/dev/xvdd",
                            "VirtualName": "ephemeral2"
                          },
                          {
                            "DeviceName": "/dev/xvde",
                            "VirtualName": "ephemeral3"
                          },
                          {
                            "DeviceName": "/dev/xvdf",
                            "VirtualName": "ephemeral4"
                          },
                          {
                            "DeviceName": "/dev/xvdg",
                            "VirtualName": "ephemeral5"
                          },
                          {
                            "DeviceName": "/dev/xvdh",
                            "VirtualName": "ephemeral6"
                          },
                          {
                            "DeviceName": "/dev/xvdi",
                            "VirtualName": "ephemeral7"
                          }
                        ],
                        {
                          "Fn::If": [
                            "is_hi1_4xlarge",
                            [
                              {
                                "DeviceName": "/dev/sda1",
                                "Ebs": {
                                  "DeleteOnTermination": "true",
                                  "VolumeSize": "32",
                                  "VolumeType": "gp2"
                                }
                              },
                              {
                                "DeviceName": "/dev/xvdb",
                                "VirtualName": "ephemeral0"
                              },
                              {
                                "DeviceName": "/dev/xvdc",
                                "VirtualName": "ephemeral1"
                              }
                            ],
                            {
                              "Fn::If": [
                                "is_m1_xlarge",
                                [
                                  {
                                    "DeviceName": "/dev/sda1",
                                    "Ebs": {
                                      "DeleteOnTermination": "true",
                                      "VolumeSize": "32",
                                      "VolumeType": "gp2"
                                    }
                                  },
                                  {
                                    "DeviceName": "/dev/xvdb",
                                    "VirtualName": "ephemeral0"
                                  },
                                  {
                                    "DeviceName": "/dev/xvdc",
                                    "VirtualName": "ephemeral1"
                                  },
                                  {
                                    "DeviceName": "/dev/xvdd",
                                    "VirtualName": "ephemeral2"
                                  }
                                ],
                                {
                                  "Fn::If": [
                                    "is_r3_xlarge",
                                    [
                                      {
                                        "DeviceName": "/dev/sda1",
                                        "Ebs": {
                                          "DeleteOnTermination": "true",
                                          "VolumeSize": "32",
                                          "VolumeType": "gp2"
                                        }
                                      },
                                      {
                                        "DeviceName": "/dev/xvdb",
                                        "VirtualName": "ephemeral0"
                                      }
                                    ],
                                    {
                                      "Fn::If": [
                                        "is_m2_4xlarge",
                                        [
                                          {
                                            "DeviceName": "/dev/sda1",
                                            "Ebs": {
                                              "DeleteOnTermination": "true",
                                              "VolumeSize": "32",
                                              "VolumeType": "gp2"
                                            }
                                          },
                                          {
                                            "DeviceName": "/dev/xvdb",
                                            "VirtualName": "ephemeral0"
                                          },
                                          {
                                            "DeviceName": "/dev/xvdc",
                                            "VirtualName": "ephemeral1"
                                          }
                                        ],
                                        {
                                          "Fn::If": [
                                            "is_c3_4xlarge",
                                            [
                                              {
                                                "DeviceName": "/dev/sda1",
                                                "Ebs": {
                                                  "DeleteOnTermination": "true",
                                                  "VolumeSize": "32",
                                                  "VolumeType": "gp2"
                                                }
                                              },
                                              {
                                                "DeviceName": "/dev/xvdb",
                                                "VirtualName": "ephemeral0"
                                              },
                                              {
                                                "DeviceName": "/dev/xvdc",
                                                "VirtualName": "ephemeral1"
                                              }
                                            ],
                                            {
                                              "Fn::If": [
                                                "is_i2_4xlarge",
                                                [
                                                  {
                                                    "DeviceName": "/dev/sda1",
                                                    "Ebs": {
                                                      "DeleteOnTermination": "true",
                                                      "VolumeSize": "32",
                                                      "VolumeType": "gp2"
                                                    }
                                                  },
                                                  {
                                                    "DeviceName": "/dev/xvdb",
                                                    "VirtualName": "ephemeral0"
                                                  },
                                                  {
                                                    "DeviceName": "/dev/xvdc",
                                                    "VirtualName": "ephemeral1"
                                                  },
                                                  {
                                                    "DeviceName": "/dev/xvdd",
                                                    "VirtualName": "ephemeral2"
                                                  },
                                                  {
                                                    "DeviceName": "/dev/xvde",
                                                    "VirtualName": "ephemeral3"
                                                  }
                                                ],
                                                {
                                                  "Fn::If": [
                                                    "is_c3_2xlarge",
                                                    [
                                                      {
                                                        "DeviceName": "/dev/sda1",
                                                        "Ebs": {
                                                          "DeleteOnTermination": "true",
                                                          "VolumeSize": "32",
                                                          "VolumeType": "gp2"
                                                        }
                                                      },
                                                      {
                                                        "DeviceName": "/dev/xvdb",
                                                        "VirtualName": "ephemeral0"
                                                      },
                                                      {
                                                        "DeviceName": "/dev/xvdc",
                                                        "VirtualName": "ephemeral1"
                                                      }
                                                    ],
                                                    {
                                                      "Fn::If": [
                                                        "is_i2_2xlarge",
                                                        [
                                                          {
                                                            "DeviceName": "/dev/sda1",
                                                            "Ebs": {
                                                              "DeleteOnTermination": "true",
                                                              "VolumeSize": "32",
                                                              "VolumeType": "gp2"
                                                            }
                                                          },
                                                          {
                                                            "DeviceName": "/dev/xvdb",
                                                            "VirtualName": "ephemeral0"
                                                          },
                                                          {
                                                            "DeviceName": "/dev/xvdc",
                                                            "VirtualName": "ephemeral1"
                                                          }
                                                        ],
                                                        {
                                                          "Fn::If": [
                                                            "is_hs1_8xlarge",
                                                            [
                                                              {
                                                                "DeviceName": "/dev/sda1",
                                                                "Ebs": {
                                                                  "DeleteOnTermination": "true",
                                                                  "VolumeSize": "32",
                                                                  "VolumeType": "gp2"
                                                                }
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdb",
                                                                "VirtualName": "ephemeral0"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdc",
                                                                "VirtualName": "ephemeral1"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdd",
                                                                "VirtualName": "ephemeral2"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvde",
                                                                "VirtualName": "ephemeral3"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdf",
                                                                "VirtualName": "ephemeral4"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdg",
                                                                "VirtualName": "ephemeral5"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdh",
                                                                "VirtualName": "ephemeral6"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdi",
                                                                "VirtualName": "ephemeral7"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdj",
                                                                "VirtualName": "ephemeral8"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdk",
                                                                "VirtualName": "ephemeral9"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdl",
                                                                "VirtualName": "ephemeral10"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdm",
                                                                "VirtualName": "ephemeral11"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdn",
                                                                "VirtualName": "ephemeral12"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdo",
                                                                "VirtualName": "ephemeral13"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdp",
                                                                "VirtualName": "ephemeral14"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdq",
                                                                "VirtualName": "ephemeral15"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdr",
                                                                "VirtualName": "ephemeral16"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvds",
                                                                "VirtualName": "ephemeral17"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdt",
                                                                "VirtualName": "ephemeral18"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdu",
                                                                "VirtualName": "ephemeral19"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdv",
                                                                "VirtualName": "ephemeral20"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdw",
                                                                "VirtualName": "ephemeral21"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdx",
                                                                "VirtualName": "ephemeral22"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdy",
                                                                "VirtualName": "ephemeral23"
                                                              }
                                                            ],
                                                            {
                                                              "Fn::If": [
                                                                "is_m1_large",
                                                                [
                                                                  {
                                                                    "DeviceName": "/dev/sda1",
                                                                    "Ebs": {
                                                                      "DeleteOnTermination": "true",
                                                                      "VolumeSize": "32",
                                                                      "VolumeType": "gp2"
                                                                    }
                                                                  },
                                                                  {
                                                                    "DeviceName": "/dev/xvdb",
                                                                    "VirtualName": "ephemeral0"
                                                                  },
                                                                  {
                                                                    "DeviceName": "/dev/xvdc",
                                                                    "VirtualName": "ephemeral1"
                                                                  }
                                                                ],
                                                                {
                                                                  "Fn::If": [
                                                                    "is_cc2_8xlarge",
                                                                    [
                                                                      {
                                                                        "DeviceName": "/dev/sda1",
                                                                        "Ebs": {
                                                                          "DeleteOnTermination": "true",
                                                                          "VolumeSize": "32",
                                                                          "VolumeType": "gp2"
                                                                        }
                                                                      },
                                                                      {
                                                                        "DeviceName": "/dev/xvdb",
                                                                        "VirtualName": "ephemeral0"
                                                                      },
                                                                      {
                                                                        "DeviceName": "/dev/xvdc",
                                                                        "VirtualName": "ephemeral1"
                                                                      },
                                                                      {
                                                                        "DeviceName": "/dev/xvdd",
                                                                        "VirtualName": "ephemeral2"
                                                                      },
                                                                      {
                                                                        "DeviceName": "/dev/xvde",
                                                                        "VirtualName": "ephemeral3"
                                                                      }
                                                                    ],
                                                                    {
                                                                      "Fn::If": [
                                                                        "is_m3_medium",
                                                                        [
                                                                          {
                                                                            "DeviceName": "/dev/sda1",
                                                                            "Ebs": {
                                                                              "DeleteOnTermination": "true",
                                                                              "VolumeSize": "32",
                                                                              "VolumeType": "gp2"
                                                                            }
                                                                          },
                                                                          {
                                                                            "DeviceName": "/dev/xvdb",
                                                                            "VirtualName": "ephemeral0"
                                                                          }
                                                                        ],
                                                                        {
                                                                          "Fn::If": [
                                                                            "is_i2_xlarge",
                                                                            [
                                                                              {
                                                                                "DeviceName": "/dev/sda1",
                                                                                "Ebs": {
                                                                                  "DeleteOnTermination": "true",
                                                                                  "VolumeSize": "32",
                                                                                  "VolumeType": "gp2"
                                                                                }
                                                                              },
                                                                              {
                                                                                "DeviceName": "/dev/xvdb",
                                                                                "VirtualName": "ephemeral0"
                                                                              }
                                                                            ],
                                                                            {
                                                                              "Fn::If": [
                                                                                "is_c3_xlarge",
                                                                                [
                                                                                  {
                                                                                    "DeviceName": "/dev/sda1",
                                                                                    "Ebs": {
                                                                                      "DeleteOnTermination": "true",
                                                                                      "VolumeSize": "32",
                                                                                      "VolumeType": "gp2"
                                                                                    }
                                                                                  },
                                                                                  {
                                                                                    "DeviceName": "/dev/xvdb",
                                                                                    "VirtualName": "ephemeral0"
                                                                                  },
                                                                                  {
                                                                                    "DeviceName": "/dev/xvdc",
                                                                                    "VirtualName": "ephemeral1"
                                                                                  }
                                                                                ],
                                                                                {
                                                                                  "Fn::If": [
                                                                                    "is_r3_large",
                                                                                    [
                                                                                      {
                                                                                        "DeviceName": "/dev/sda1",
                                                                                        "Ebs": {
                                                                                          "DeleteOnTermination": "true",
                                                                                          "VolumeSize": "32",
                                                                                          "VolumeType": "gp2"
                                                                                        }
                                                                                      },
                                                                                      {
                                                                                        "DeviceName": "/dev/xvdb",
                                                                                        "VirtualName": "ephemeral0"
                                                                                      }
                                                                                    ],
                                                                                    {
                                                                                      "Fn::If": [
                                                                                        "is_g2_2xlarge",
                                                                                        [
                                                                                          {
                                                                                            "DeviceName": "/dev/sda1",
                                                                                            "Ebs": {
                                                                                              "DeleteOnTermination": "true",
                                                                                              "VolumeSize": "32",
                                                                                              "VolumeType": "gp2"
                                                                                            }
                                                                                          },
                                                                                          {
                                                                                            "DeviceName": "/dev/xvdb",
                                                                                            "VirtualName": "ephemeral0"
                                                                                          }
                                                                                        ],
                                                                                        {
                                                                                          "Fn::If": [
                                                                                            "is_m1_medium",
                                                                                            [
                                                                                              {
                                                                                                "DeviceName": "/dev/sda1",
                                                                                                "Ebs": {
                                                                                                  "DeleteOnTermination": "true",
                                                                                                  "VolumeSize": "32",
                                                                                                  "VolumeType": "gp2"
                                                                                                }
                                                                                              },
                                                                                              {
                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                "VirtualName": "ephemeral0"
                                                                                              }
                                                                                            ],
                                                                                            {
                                                                                              "Fn::If": [
                                                                                                "is_c3_large",
                                                                                                [
                                                                                                  {
                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                    "Ebs": {
                                                                                                      "DeleteOnTermination": "true",
                                                                                                      "VolumeSize": "32",
                                                                                                      "VolumeType": "gp2"
                                                                                                    }
                                                                                                  },
                                                                                                  {
                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                    "VirtualName": "ephemeral0"
                                                                                                  },
                                                                                                  {
                                                                                                    "DeviceName": "/dev/xvdc",
                                                                                                    "VirtualName": "ephemeral1"
                                                                                                  }
                                                                                                ],
                                                                                                {
                                                                                                  "Fn::If": [
                                                                                                    "is_cr1_8xlarge",
                                                                                                    [
                                                                                                      {
                                                                                                        "DeviceName": "/dev/sda1",
                                                                                                        "Ebs": {
                                                                                                          "DeleteOnTermination": "true",
                                                                                                          "VolumeSize": "32",
                                                                                                          "VolumeType": "gp2"
                                                                                                        }
                                                                                                      },
                                                                                                      {
                                                                                                        "DeviceName": "/dev/xvdb",
                                                                                                        "VirtualName": "ephemeral0"
                                                                                                      },
                                                                                                      {
                                                                                                        "DeviceName": "/dev/xvdc",
                                                                                                        "VirtualName": "ephemeral1"
                                                                                                      }
                                                                                                    ],
                                                                                                    {
                                                                                                      "Fn::If": [
                                                                                                        "is_c3_8xlarge",
                                                                                                        [
                                                                                                          {
                                                                                                            "DeviceName": "/dev/sda1",
                                                                                                            "Ebs": {
                                                                                                              "DeleteOnTermination": "true",
                                                                                                              "VolumeSize": "32",
                                                                                                              "VolumeType": "gp2"
                                                                                                            }
                                                                                                          },
                                                                                                          {
                                                                                                            "DeviceName": "/dev/xvdb",
                                                                                                            "VirtualName": "ephemeral0"
                                                                                                          },
                                                                                                          {
                                                                                                            "DeviceName": "/dev/xvdc",
                                                                                                            "VirtualName": "ephemeral1"
                                                                                                          }
                                                                                                        ],
                                                                                                        {
                                                                                                          "Fn::If": [
                                                                                                            "is_r3_2xlarge",
                                                                                                            [
                                                                                                              {
                                                                                                                "DeviceName": "/dev/sda1",
                                                                                                                "Ebs": {
                                                                                                                  "DeleteOnTermination": "true",
                                                                                                                  "VolumeSize": "32",
                                                                                                                  "VolumeType": "gp2"
                                                                                                                }
                                                                                                              },
                                                                                                              {
                                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                                "VirtualName": "ephemeral0"
                                                                                                              }
                                                                                                            ],
                                                                                                            {
                                                                                                              "Fn::If": [
                                                                                                                "is_m2_xlarge",
                                                                                                                [
                                                                                                                  {
                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                    "Ebs": {
                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                      "VolumeSize": "32",
                                                                                                                      "VolumeType": "gp2"
                                                                                                                    }
                                                                                                                  },
                                                                                                                  {
                                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                                    "VirtualName": "ephemeral0"
                                                                                                                  }
                                                                                                                ],
                                                                                                                {
                                                                                                                  "Fn::If": [
                                                                                                                    "is_r3_8xlarge",
                                                                                                                    [
                                                                                                                      {
                                                                                                                        "DeviceName": "/dev/sda1",
                                                                                                                        "Ebs": {
                                                                                                                          "DeleteOnTermination": "true",
                                                                                                                          "VolumeSize": "32",
                                                                                                                          "VolumeType": "gp2"
                                                                                                                        }
                                                                                                                      },
                                                                                                                      {
                                                                                                                        "DeviceName": "/dev/xvdb",
                                                                                                                        "VirtualName": "ephemeral0"
                                                                                                                      },
                                                                                                                      {
                                                                                                                        "DeviceName": "/dev/xvdc",
                                                                                                                        "VirtualName": "ephemeral1"
                                                                                                                      }
                                                                                                                    ],
                                                                                                                    {
                                                                                                                      "Fn::If": [
                                                                                                                        "is_d2_8xlarge",
                                                                                                                        [
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/sda1",
                                                                                                                            "Ebs": {
                                                                                                                              "DeleteOnTermination": "true",
                                                                                                                              "VolumeSize": "32",
                                                                                                                              "VolumeType": "gp2"
                                                                                                                            }
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdb",
                                                                                                                            "VirtualName": "ephemeral0"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdc",
                                                                                                                            "VirtualName": "ephemeral1"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdd",
                                                                                                                            "VirtualName": "ephemeral2"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvde",
                                                                                                                            "VirtualName": "ephemeral3"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdf",
                                                                                                                            "VirtualName": "ephemeral4"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdg",
                                                                                                                            "VirtualName": "ephemeral5"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdh",
                                                                                                                            "VirtualName": "ephemeral6"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdi",
                                                                                                                            "VirtualName": "ephemeral7"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdj",
                                                                                                                            "VirtualName": "ephemeral8"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdk",
                                                                                                                            "VirtualName": "ephemeral9"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdl",
                                                                                                                            "VirtualName": "ephemeral10"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdm",
                                                                                                                            "VirtualName": "ephemeral11"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdn",
                                                                                                                            "VirtualName": "ephemeral12"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdo",
                                                                                                                            "VirtualName": "ephemeral13"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdp",
                                                                                                                            "VirtualName": "ephemeral14"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdq",
                                                                                                                            "VirtualName": "ephemeral15"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdr",
                                                                                                                            "VirtualName": "ephemeral16"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvds",
                                                                                                                            "VirtualName": "ephemeral17"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdt",
                                                                                                                            "VirtualName": "ephemeral18"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdu",
                                                                                                                            "VirtualName": "ephemeral19"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdv",
                                                                                                                            "VirtualName": "ephemeral20"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdw",
                                                                                                                            "VirtualName": "ephemeral21"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdx",
                                                                                                                            "VirtualName": "ephemeral22"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdy",
                                                                                                                            "VirtualName": "ephemeral23"
                                                                                                                          }
                                                                                                                        ],
                                                                                                                        {
                                                                                                                          "Fn::If": [
                                                                                                                            "is_c1_medium",
                                                                                                                            [
                                                                                                                              {
                                                                                                                                "DeviceName": "/dev/sda1",
                                                                                                                                "Ebs": {
                                                                                                                                  "DeleteOnTermination": "true",
                                                                                                                                  "VolumeSize": "32",
                                                                                                                                  "VolumeType": "gp2"
                                                                                                                                }
                                                                                                                              },
                                                                                                                              {
                                                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                                                "VirtualName": "ephemeral0"
                                                                                                                              }
                                                                                                                            ],
                                                                                                                            {
                                                                                                                              "Fn::If": [
                                                                                                                                "is_m1_small",
                                                                                                                                [
                                                                                                                                  {
                                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                                    "Ebs": {
                                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                                      "VolumeSize": "32",
                                                                                                                                      "VolumeType": "gp2"
                                                                                                                                    }
                                                                                                                                  },
                                                                                                                                  {
                                                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                                                    "VirtualName": "ephemeral0"
                                                                                                                                  }
                                                                                                                                ],
                                                                                                                                {
                                                                                                                                  "Fn::If": [
                                                                                                                                    "is_d2_xlarge",
                                                                                                                                    [
                                                                                                                                      {
                                                                                                                                        "DeviceName": "/dev/sda1",
                                                                                                                                        "Ebs": {
                                                                                                                                          "DeleteOnTermination": "true",
                                                                                                                                          "VolumeSize": "32",
                                                                                                                                          "VolumeType": "gp2"
                                                                                                                                        }
                                                                                                                                      },
                                                                                                                                      {
                                                                                                                                        "DeviceName": "/dev/xvdb",
                                                                                                                                        "VirtualName": "ephemeral0"
                                                                                                                                      },
                                                                                                                                      {
                                                                                                                                        "DeviceName": "/dev/xvdc",
                                                                                                                                        "VirtualName": "ephemeral1"
                                                                                                                                      },
                                                                                                                                      {
                                                                                                                                        "DeviceName": "/dev/xvdd",
                                                                                                                                        "VirtualName": "ephemeral2"
                                                                                                                                      }
                                                                                                                                    ],
                                                                                                                                    {
                                                                                                                                      "Fn::If": [
                                                                                                                                        "is_r3_4xlarge",
                                                                                                                                        [
                                                                                                                                          {
                                                                                                                                            "DeviceName": "/dev/sda1",
                                                                                                                                            "Ebs": {
                                                                                                                                              "DeleteOnTermination": "true",
                                                                                                                                              "VolumeSize": "32",
                                                                                                                                              "VolumeType": "gp2"
                                                                                                                                            }
                                                                                                                                          },
                                                                                                                                          {
                                                                                                                                            "DeviceName": "/dev/xvdb",
                                                                                                                                            "VirtualName": "ephemeral0"
                                                                                                                                          }
                                                                                                                                        ],
                                                                                                                                        {
                                                                                                                                          "Fn::If": [
                                                                                                                                            "is_c1_xlarge",
                                                                                                                                            [
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/sda1",
                                                                                                                                                "Ebs": {
                                                                                                                                                  "DeleteOnTermination": "true",
                                                                                                                                                  "VolumeSize": "32",
                                                                                                                                                  "VolumeType": "gp2"
                                                                                                                                                }
                                                                                                                                              },
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                                                                "VirtualName": "ephemeral0"
                                                                                                                                              },
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/xvdc",
                                                                                                                                                "VirtualName": "ephemeral1"
                                                                                                                                              },
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/xvdd",
                                                                                                                                                "VirtualName": "ephemeral2"
                                                                                                                                              },
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/xvde",
                                                                                                                                                "VirtualName": "ephemeral3"
                                                                                                                                              }
                                                                                                                                            ],
                                                                                                                                            {
                                                                                                                                              "Fn::If": [
                                                                                                                                                "is_m3_2xlarge",
                                                                                                                                                [
                                                                                                                                                  {
                                                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                                                    "Ebs": {
                                                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                                                      "VolumeSize": "32",
                                                                                                                                                      "VolumeType": "gp2"
                                                                                                                                                    }
                                                                                                                                                  },
                                                                                                                                                  {
                                                                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                                                                    "VirtualName": "ephemeral0"
                                                                                                                                                  },
                                                                                                                                                  {
                                                                                                                                                    "DeviceName": "/dev/xvdc",
                                                                                                                                                    "VirtualName": "ephemeral1"
                                                                                                                                                  }
                                                                                                                                                ],
                                                                                                                                                {
                                                                                                                                                  "Fn::If": [
                                                                                                                                                    "is_cg1_4xlarge",
                                                                                                                                                    [
                                                                                                                                                      {
                                                                                                                                                        "DeviceName": "/dev/sda1",
                                                                                                                                                        "Ebs": {
                                                                                                                                                          "DeleteOnTermination": "true",
                                                                                                                                                          "VolumeSize": "32",
                                                                                                                                                          "VolumeType": "gp2"
                                                                                                                                                        }
                                                                                                                                                      },
                                                                                                                                                      {
                                                                                                                                                        "DeviceName": "/dev/xvdb",
                                                                                                                                                        "VirtualName": "ephemeral0"
                                                                                                                                                      },
                                                                                                                                                      {
                                                                                                                                                        "DeviceName": "/dev/xvdc",
                                                                                                                                                        "VirtualName": "ephemeral1"
                                                                                                                                                      }
                                                                                                                                                    ],
                                                                                                                                                    {
                                                                                                                                                      "Fn::If": [
                                                                                                                                                        "is_g2_8xlarge",
                                                                                                                                                        [
                                                                                                                                                          {
                                                                                                                                                            "DeviceName": "/dev/sda1",
                                                                                                                                                            "Ebs": {
                                                                                                                                                              "DeleteOnTermination": "true",
                                                                                                                                                              "VolumeSize": "32",
                                                                                                                                                              "VolumeType": "gp2"
                                                                                                                                                            }
                                                                                                                                                          },
                                                                                                                                                          {
                                                                                                                                                            "DeviceName": "/dev/xvdb",
                                                                                                                                                            "VirtualName": "ephemeral0"
                                                                                                                                                          },
                                                                                                                                                          {
                                                                                                                                                            "DeviceName": "/dev/xvdc",
                                                                                                                                                            "VirtualName": "ephemeral1"
                                                                                                                                                          }
                                                                                                                                                        ],
                                                                                                                                                        {
                                                                                                                                                          "Fn::If": [
                                                                                                                                                            "is_d2_2xlarge",
                                                                                                                                                            [
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/sda1",
                                                                                                                                                                "Ebs": {
                                                                                                                                                                  "DeleteOnTermination": "true",
                                                                                                                                                                  "VolumeSize": "32",
                                                                                                                                                                  "VolumeType": "gp2"
                                                                                                                                                                }
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                                                                                "VirtualName": "ephemeral0"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdc",
                                                                                                                                                                "VirtualName": "ephemeral1"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdd",
                                                                                                                                                                "VirtualName": "ephemeral2"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvde",
                                                                                                                                                                "VirtualName": "ephemeral3"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdf",
                                                                                                                                                                "VirtualName": "ephemeral4"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdg",
                                                                                                                                                                "VirtualName": "ephemeral5"
                                                                                                                                                              }
                                                                                                                                                            ],
                                                                                                                                                            {
                                                                                                                                                              "Fn::If": [
                                                                                                                                                                "is_m3_large",
                                                                                                                                                                [
                                                                                                                                                                  {
                                                                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                                                                    "Ebs": {
                                                                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                                                                      "VolumeSize": "32",
                                                                                                                                                                      "VolumeType": "gp2"
                                                                                                                                                                    }
                                                                                                                                                                  },
                                                                                                                                                                  {
                                                                                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                                                                                    "VirtualName": "ephemeral0"
                                                                                                                                                                  }
                                                                                                                                                                ],
                                                                                                                                                                [
                                                                                                                                                                  {
                                                                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                                                                    "Ebs": {
                                                                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                                                                      "VolumeSize": "32",
                                                                                                                                                                      "VolumeType": "gp2"
                                                                                                                                                                    }
                                                                                                                                                                  }
                                                                                                                                                                ]
                                                                                                                                                              ]
                                                                                                                                                            }
                                                                                                                                                          ]
                                                                                                                                                        }
                                                                                                                                                      ]
                                                                                                                                                    }
                                                                                                                                                  ]
                                                                                                                                                }
                                                                                                                                              ]
                                                                                                                                            }
                                                                                                                                          ]
                                                                                                                                        }
                                                                                                                                      ]
                                                                                                                                    }
                                                                                                                                  ]
                                                                                                                                }
                                                                                                                              ]
                                                                                                                            }
                                                                                                                          ]
                                                                                                                        }
                                                                                                                      ]
                                                                                                                    }
                                                                                                                  ]
                                                                                                                }
                                                                                                              ]
                                                                                                            }
                                                                                                          ]
                                                                                                        }
                                                                                                      ]
                                                                                                    }
                                                                                                  ]
                                                                                                }
                                                                                              ]
                                                                                            }
                                                                                          ]
                                                                                        }
                                                                                      ]
                                                                                    }
                                                                                  ]
                                                                                }
                                                                              ]
                                                                            }
                                                                          ]
                                                                        }
                                                                      ]
                                                                    }
                                                                  ]
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    "EC2InstanceWithPlacementGroup": {
      "Type": "AWS::EC2::Instance",
      "Condition" : "UsePlacementGroup",
      "Properties": {
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "SecurityGroupIds": {
          "Ref": "HadoopInstanceSecurityGroupId"
        },
        "SubnetId": {
          "Ref": "SubnetId"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "PlacementGroupName" : { "Ref": "PlacementGroupName" },
        "ImageId": {
          "Fn::FindInMap": [
            "RegionalAMIs",
            {
              "Ref": "AWS::Region"
            },
            "Hadoop"
          ]
        },
        "IamInstanceProfile": { "Ref": "HadoopInstanceProfile" },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::Region"
                  },
                  {
                    "Ref": "AWS::StackName"
                  },
                  "-ec2"
                ]
              ]
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -xe\n",
                "chkconfig ntpd on\n",
                "service ntpd start\n",
                "echo 'umask 022' > /etc/profile.d/umask.sh\n",
                "setenforce 0\n",
                "sed -i 's/^SELINUX=.*$/SELINUX=permissive/' /etc/selinux/config\n",
                "cd /tmp && curl -O https://bootstrap.pypa.io/get-pip.py && python get-pip.py && pip install awscli\n",
                "cd /etc/yum.repos.d && wget http://public-repo-1.hortonworks.com/ambari/centos6/2.x/updates/2.2.0.0/ambari.repo\n",
                "test -f /sys/kernel/mm/transparent_hugepage/enabled && echo never > /sys/kernel/mm/redhat_transparent_hugepage/enabled\n",
                "test -f /sys/kernel/mm/transparent_hugepage/defrag && echo never > /sys/kernel/mm/redhat_transparent_hugepage/defrag\n",
                "yum install ambari-agent -y\n",
                "ebs_i=0; BEGIN_TIME=`date +%s`\n",
                "while read DISK; do\n",
                "ebs_i=`expr $ebs_i + 1`; mkdir -p /hadoop$ebs_i; chmod 755 /hadoop$ebs_i\n",
                "( mkfs -t ext4 /dev/${DISK} && mount /dev/${DISK} /hadoop$ebs_i && chmod 777 /hadoop$ebs_i ) 2>/dev/null >/dev/null &\n",
                "done <<< \"$( lsblk | sed '1,3d' | cut -d' ' -f1 )\"\n",
                "echo Number of disks to be used for Hadoop: $ebs_i\n",
                "while [ $( ls -ld /hadoop* | grep '^.rwxrwxrwx' | wc -l ) -lt $ebs_i ]; do\n",
                "sleep 1; echo Number of disks ready: $( ls -ld /hadoop* | grep '^.rwxrwxrwx' | wc -l )\n",
                "done\n",
                "END_TIME=`date +%s`; echo Disk formatting and mounting took $( expr $END_TIME - $BEGIN_TIME ) seconds\n",
                "sed -i -e 's/^hostname=.*$/hostname=",
                {
                  "Ref": "AmbariPrivateDns"
                },
                "/' -e 's/^run_as_user=.*$/run_as_user=ec2-user/' /etc/ambari-agent/conf/ambari-agent.ini\n",
                "ambari-agent start\n"
              ]
            ]
          }
        },
        "BlockDeviceMappings": {
          "Fn::If": [
            "is_d2_4xlarge",
            [
              {
                "DeviceName": "/dev/sda1",
                "Ebs": {
                  "DeleteOnTermination": "true",
                  "VolumeSize": "32",
                  "VolumeType": "gp2"
                }
              },
              {
                "DeviceName": "/dev/xvdb",
                "VirtualName": "ephemeral0"
              },
              {
                "DeviceName": "/dev/xvdc",
                "VirtualName": "ephemeral1"
              },
              {
                "DeviceName": "/dev/xvdd",
                "VirtualName": "ephemeral2"
              },
              {
                "DeviceName": "/dev/xvde",
                "VirtualName": "ephemeral3"
              },
              {
                "DeviceName": "/dev/xvdf",
                "VirtualName": "ephemeral4"
              },
              {
                "DeviceName": "/dev/xvdg",
                "VirtualName": "ephemeral5"
              },
              {
                "DeviceName": "/dev/xvdh",
                "VirtualName": "ephemeral6"
              },
              {
                "DeviceName": "/dev/xvdi",
                "VirtualName": "ephemeral7"
              },
              {
                "DeviceName": "/dev/xvdj",
                "VirtualName": "ephemeral8"
              },
              {
                "DeviceName": "/dev/xvdk",
                "VirtualName": "ephemeral9"
              },
              {
                "DeviceName": "/dev/xvdl",
                "VirtualName": "ephemeral10"
              },
              {
                "DeviceName": "/dev/xvdm",
                "VirtualName": "ephemeral11"
              }
            ],
            {
              "Fn::If": [
                "is_m3_xlarge",
                [
                  {
                    "DeviceName": "/dev/sda1",
                    "Ebs": {
                      "DeleteOnTermination": "true",
                      "VolumeSize": "32",
                      "VolumeType": "gp2"
                    }
                  },
                  {
                    "DeviceName": "/dev/xvdb",
                    "VirtualName": "ephemeral0"
                  },
                  {
                    "DeviceName": "/dev/xvdc",
                    "VirtualName": "ephemeral1"
                  }
                ],
                {
                  "Fn::If": [
                    "is_m2_2xlarge",
                    [
                      {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                          "DeleteOnTermination": "true",
                          "VolumeSize": "32",
                          "VolumeType": "gp2"
                        }
                      },
                      {
                        "DeviceName": "/dev/xvdb",
                        "VirtualName": "ephemeral0"
                      }
                    ],
                    {
                      "Fn::If": [
                        "is_i2_8xlarge",
                        [
                          {
                            "DeviceName": "/dev/sda1",
                            "Ebs": {
                              "DeleteOnTermination": "true",
                              "VolumeSize": "32",
                              "VolumeType": "gp2"
                            }
                          },
                          {
                            "DeviceName": "/dev/xvdb",
                            "VirtualName": "ephemeral0"
                          },
                          {
                            "DeviceName": "/dev/xvdc",
                            "VirtualName": "ephemeral1"
                          },
                          {
                            "DeviceName": "/dev/xvdd",
                            "VirtualName": "ephemeral2"
                          },
                          {
                            "DeviceName": "/dev/xvde",
                            "VirtualName": "ephemeral3"
                          },
                          {
                            "DeviceName": "/dev/xvdf",
                            "VirtualName": "ephemeral4"
                          },
                          {
                            "DeviceName": "/dev/xvdg",
                            "VirtualName": "ephemeral5"
                          },
                          {
                            "DeviceName": "/dev/xvdh",
                            "VirtualName": "ephemeral6"
                          },
                          {
                            "DeviceName": "/dev/xvdi",
                            "VirtualName": "ephemeral7"
                          }
                        ],
                        {
                          "Fn::If": [
                            "is_hi1_4xlarge",
                            [
                              {
                                "DeviceName": "/dev/sda1",
                                "Ebs": {
                                  "DeleteOnTermination": "true",
                                  "VolumeSize": "32",
                                  "VolumeType": "gp2"
                                }
                              },
                              {
                                "DeviceName": "/dev/xvdb",
                                "VirtualName": "ephemeral0"
                              },
                              {
                                "DeviceName": "/dev/xvdc",
                                "VirtualName": "ephemeral1"
                              }
                            ],
                            {
                              "Fn::If": [
                                "is_m1_xlarge",
                                [
                                  {
                                    "DeviceName": "/dev/sda1",
                                    "Ebs": {
                                      "DeleteOnTermination": "true",
                                      "VolumeSize": "32",
                                      "VolumeType": "gp2"
                                    }
                                  },
                                  {
                                    "DeviceName": "/dev/xvdb",
                                    "VirtualName": "ephemeral0"
                                  },
                                  {
                                    "DeviceName": "/dev/xvdc",
                                    "VirtualName": "ephemeral1"
                                  },
                                  {
                                    "DeviceName": "/dev/xvdd",
                                    "VirtualName": "ephemeral2"
                                  }
                                ],
                                {
                                  "Fn::If": [
                                    "is_r3_xlarge",
                                    [
                                      {
                                        "DeviceName": "/dev/sda1",
                                        "Ebs": {
                                          "DeleteOnTermination": "true",
                                          "VolumeSize": "32",
                                          "VolumeType": "gp2"
                                        }
                                      },
                                      {
                                        "DeviceName": "/dev/xvdb",
                                        "VirtualName": "ephemeral0"
                                      }
                                    ],
                                    {
                                      "Fn::If": [
                                        "is_m2_4xlarge",
                                        [
                                          {
                                            "DeviceName": "/dev/sda1",
                                            "Ebs": {
                                              "DeleteOnTermination": "true",
                                              "VolumeSize": "32",
                                              "VolumeType": "gp2"
                                            }
                                          },
                                          {
                                            "DeviceName": "/dev/xvdb",
                                            "VirtualName": "ephemeral0"
                                          },
                                          {
                                            "DeviceName": "/dev/xvdc",
                                            "VirtualName": "ephemeral1"
                                          }
                                        ],
                                        {
                                          "Fn::If": [
                                            "is_c3_4xlarge",
                                            [
                                              {
                                                "DeviceName": "/dev/sda1",
                                                "Ebs": {
                                                  "DeleteOnTermination": "true",
                                                  "VolumeSize": "32",
                                                  "VolumeType": "gp2"
                                                }
                                              },
                                              {
                                                "DeviceName": "/dev/xvdb",
                                                "VirtualName": "ephemeral0"
                                              },
                                              {
                                                "DeviceName": "/dev/xvdc",
                                                "VirtualName": "ephemeral1"
                                              }
                                            ],
                                            {
                                              "Fn::If": [
                                                "is_i2_4xlarge",
                                                [
                                                  {
                                                    "DeviceName": "/dev/sda1",
                                                    "Ebs": {
                                                      "DeleteOnTermination": "true",
                                                      "VolumeSize": "32",
                                                      "VolumeType": "gp2"
                                                    }
                                                  },
                                                  {
                                                    "DeviceName": "/dev/xvdb",
                                                    "VirtualName": "ephemeral0"
                                                  },
                                                  {
                                                    "DeviceName": "/dev/xvdc",
                                                    "VirtualName": "ephemeral1"
                                                  },
                                                  {
                                                    "DeviceName": "/dev/xvdd",
                                                    "VirtualName": "ephemeral2"
                                                  },
                                                  {
                                                    "DeviceName": "/dev/xvde",
                                                    "VirtualName": "ephemeral3"
                                                  }
                                                ],
                                                {
                                                  "Fn::If": [
                                                    "is_c3_2xlarge",
                                                    [
                                                      {
                                                        "DeviceName": "/dev/sda1",
                                                        "Ebs": {
                                                          "DeleteOnTermination": "true",
                                                          "VolumeSize": "32",
                                                          "VolumeType": "gp2"
                                                        }
                                                      },
                                                      {
                                                        "DeviceName": "/dev/xvdb",
                                                        "VirtualName": "ephemeral0"
                                                      },
                                                      {
                                                        "DeviceName": "/dev/xvdc",
                                                        "VirtualName": "ephemeral1"
                                                      }
                                                    ],
                                                    {
                                                      "Fn::If": [
                                                        "is_i2_2xlarge",
                                                        [
                                                          {
                                                            "DeviceName": "/dev/sda1",
                                                            "Ebs": {
                                                              "DeleteOnTermination": "true",
                                                              "VolumeSize": "32",
                                                              "VolumeType": "gp2"
                                                            }
                                                          },
                                                          {
                                                            "DeviceName": "/dev/xvdb",
                                                            "VirtualName": "ephemeral0"
                                                          },
                                                          {
                                                            "DeviceName": "/dev/xvdc",
                                                            "VirtualName": "ephemeral1"
                                                          }
                                                        ],
                                                        {
                                                          "Fn::If": [
                                                            "is_hs1_8xlarge",
                                                            [
                                                              {
                                                                "DeviceName": "/dev/sda1",
                                                                "Ebs": {
                                                                  "DeleteOnTermination": "true",
                                                                  "VolumeSize": "32",
                                                                  "VolumeType": "gp2"
                                                                }
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdb",
                                                                "VirtualName": "ephemeral0"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdc",
                                                                "VirtualName": "ephemeral1"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdd",
                                                                "VirtualName": "ephemeral2"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvde",
                                                                "VirtualName": "ephemeral3"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdf",
                                                                "VirtualName": "ephemeral4"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdg",
                                                                "VirtualName": "ephemeral5"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdh",
                                                                "VirtualName": "ephemeral6"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdi",
                                                                "VirtualName": "ephemeral7"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdj",
                                                                "VirtualName": "ephemeral8"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdk",
                                                                "VirtualName": "ephemeral9"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdl",
                                                                "VirtualName": "ephemeral10"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdm",
                                                                "VirtualName": "ephemeral11"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdn",
                                                                "VirtualName": "ephemeral12"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdo",
                                                                "VirtualName": "ephemeral13"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdp",
                                                                "VirtualName": "ephemeral14"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdq",
                                                                "VirtualName": "ephemeral15"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdr",
                                                                "VirtualName": "ephemeral16"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvds",
                                                                "VirtualName": "ephemeral17"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdt",
                                                                "VirtualName": "ephemeral18"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdu",
                                                                "VirtualName": "ephemeral19"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdv",
                                                                "VirtualName": "ephemeral20"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdw",
                                                                "VirtualName": "ephemeral21"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdx",
                                                                "VirtualName": "ephemeral22"
                                                              },
                                                              {
                                                                "DeviceName": "/dev/xvdy",
                                                                "VirtualName": "ephemeral23"
                                                              }
                                                            ],
                                                            {
                                                              "Fn::If": [
                                                                "is_m1_large",
                                                                [
                                                                  {
                                                                    "DeviceName": "/dev/sda1",
                                                                    "Ebs": {
                                                                      "DeleteOnTermination": "true",
                                                                      "VolumeSize": "32",
                                                                      "VolumeType": "gp2"
                                                                    }
                                                                  },
                                                                  {
                                                                    "DeviceName": "/dev/xvdb",
                                                                    "VirtualName": "ephemeral0"
                                                                  },
                                                                  {
                                                                    "DeviceName": "/dev/xvdc",
                                                                    "VirtualName": "ephemeral1"
                                                                  }
                                                                ],
                                                                {
                                                                  "Fn::If": [
                                                                    "is_cc2_8xlarge",
                                                                    [
                                                                      {
                                                                        "DeviceName": "/dev/sda1",
                                                                        "Ebs": {
                                                                          "DeleteOnTermination": "true",
                                                                          "VolumeSize": "32",
                                                                          "VolumeType": "gp2"
                                                                        }
                                                                      },
                                                                      {
                                                                        "DeviceName": "/dev/xvdb",
                                                                        "VirtualName": "ephemeral0"
                                                                      },
                                                                      {
                                                                        "DeviceName": "/dev/xvdc",
                                                                        "VirtualName": "ephemeral1"
                                                                      },
                                                                      {
                                                                        "DeviceName": "/dev/xvdd",
                                                                        "VirtualName": "ephemeral2"
                                                                      },
                                                                      {
                                                                        "DeviceName": "/dev/xvde",
                                                                        "VirtualName": "ephemeral3"
                                                                      }
                                                                    ],
                                                                    {
                                                                      "Fn::If": [
                                                                        "is_m3_medium",
                                                                        [
                                                                          {
                                                                            "DeviceName": "/dev/sda1",
                                                                            "Ebs": {
                                                                              "DeleteOnTermination": "true",
                                                                              "VolumeSize": "32",
                                                                              "VolumeType": "gp2"
                                                                            }
                                                                          },
                                                                          {
                                                                            "DeviceName": "/dev/xvdb",
                                                                            "VirtualName": "ephemeral0"
                                                                          }
                                                                        ],
                                                                        {
                                                                          "Fn::If": [
                                                                            "is_i2_xlarge",
                                                                            [
                                                                              {
                                                                                "DeviceName": "/dev/sda1",
                                                                                "Ebs": {
                                                                                  "DeleteOnTermination": "true",
                                                                                  "VolumeSize": "32",
                                                                                  "VolumeType": "gp2"
                                                                                }
                                                                              },
                                                                              {
                                                                                "DeviceName": "/dev/xvdb",
                                                                                "VirtualName": "ephemeral0"
                                                                              }
                                                                            ],
                                                                            {
                                                                              "Fn::If": [
                                                                                "is_c3_xlarge",
                                                                                [
                                                                                  {
                                                                                    "DeviceName": "/dev/sda1",
                                                                                    "Ebs": {
                                                                                      "DeleteOnTermination": "true",
                                                                                      "VolumeSize": "32",
                                                                                      "VolumeType": "gp2"
                                                                                    }
                                                                                  },
                                                                                  {
                                                                                    "DeviceName": "/dev/xvdb",
                                                                                    "VirtualName": "ephemeral0"
                                                                                  },
                                                                                  {
                                                                                    "DeviceName": "/dev/xvdc",
                                                                                    "VirtualName": "ephemeral1"
                                                                                  }
                                                                                ],
                                                                                {
                                                                                  "Fn::If": [
                                                                                    "is_r3_large",
                                                                                    [
                                                                                      {
                                                                                        "DeviceName": "/dev/sda1",
                                                                                        "Ebs": {
                                                                                          "DeleteOnTermination": "true",
                                                                                          "VolumeSize": "32",
                                                                                          "VolumeType": "gp2"
                                                                                        }
                                                                                      },
                                                                                      {
                                                                                        "DeviceName": "/dev/xvdb",
                                                                                        "VirtualName": "ephemeral0"
                                                                                      }
                                                                                    ],
                                                                                    {
                                                                                      "Fn::If": [
                                                                                        "is_g2_2xlarge",
                                                                                        [
                                                                                          {
                                                                                            "DeviceName": "/dev/sda1",
                                                                                            "Ebs": {
                                                                                              "DeleteOnTermination": "true",
                                                                                              "VolumeSize": "32",
                                                                                              "VolumeType": "gp2"
                                                                                            }
                                                                                          },
                                                                                          {
                                                                                            "DeviceName": "/dev/xvdb",
                                                                                            "VirtualName": "ephemeral0"
                                                                                          }
                                                                                        ],
                                                                                        {
                                                                                          "Fn::If": [
                                                                                            "is_m1_medium",
                                                                                            [
                                                                                              {
                                                                                                "DeviceName": "/dev/sda1",
                                                                                                "Ebs": {
                                                                                                  "DeleteOnTermination": "true",
                                                                                                  "VolumeSize": "32",
                                                                                                  "VolumeType": "gp2"
                                                                                                }
                                                                                              },
                                                                                              {
                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                "VirtualName": "ephemeral0"
                                                                                              }
                                                                                            ],
                                                                                            {
                                                                                              "Fn::If": [
                                                                                                "is_c3_large",
                                                                                                [
                                                                                                  {
                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                    "Ebs": {
                                                                                                      "DeleteOnTermination": "true",
                                                                                                      "VolumeSize": "32",
                                                                                                      "VolumeType": "gp2"
                                                                                                    }
                                                                                                  },
                                                                                                  {
                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                    "VirtualName": "ephemeral0"
                                                                                                  },
                                                                                                  {
                                                                                                    "DeviceName": "/dev/xvdc",
                                                                                                    "VirtualName": "ephemeral1"
                                                                                                  }
                                                                                                ],
                                                                                                {
                                                                                                  "Fn::If": [
                                                                                                    "is_cr1_8xlarge",
                                                                                                    [
                                                                                                      {
                                                                                                        "DeviceName": "/dev/sda1",
                                                                                                        "Ebs": {
                                                                                                          "DeleteOnTermination": "true",
                                                                                                          "VolumeSize": "32",
                                                                                                          "VolumeType": "gp2"
                                                                                                        }
                                                                                                      },
                                                                                                      {
                                                                                                        "DeviceName": "/dev/xvdb",
                                                                                                        "VirtualName": "ephemeral0"
                                                                                                      },
                                                                                                      {
                                                                                                        "DeviceName": "/dev/xvdc",
                                                                                                        "VirtualName": "ephemeral1"
                                                                                                      }
                                                                                                    ],
                                                                                                    {
                                                                                                      "Fn::If": [
                                                                                                        "is_c3_8xlarge",
                                                                                                        [
                                                                                                          {
                                                                                                            "DeviceName": "/dev/sda1",
                                                                                                            "Ebs": {
                                                                                                              "DeleteOnTermination": "true",
                                                                                                              "VolumeSize": "32",
                                                                                                              "VolumeType": "gp2"
                                                                                                            }
                                                                                                          },
                                                                                                          {
                                                                                                            "DeviceName": "/dev/xvdb",
                                                                                                            "VirtualName": "ephemeral0"
                                                                                                          },
                                                                                                          {
                                                                                                            "DeviceName": "/dev/xvdc",
                                                                                                            "VirtualName": "ephemeral1"
                                                                                                          }
                                                                                                        ],
                                                                                                        {
                                                                                                          "Fn::If": [
                                                                                                            "is_r3_2xlarge",
                                                                                                            [
                                                                                                              {
                                                                                                                "DeviceName": "/dev/sda1",
                                                                                                                "Ebs": {
                                                                                                                  "DeleteOnTermination": "true",
                                                                                                                  "VolumeSize": "32",
                                                                                                                  "VolumeType": "gp2"
                                                                                                                }
                                                                                                              },
                                                                                                              {
                                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                                "VirtualName": "ephemeral0"
                                                                                                              }
                                                                                                            ],
                                                                                                            {
                                                                                                              "Fn::If": [
                                                                                                                "is_m2_xlarge",
                                                                                                                [
                                                                                                                  {
                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                    "Ebs": {
                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                      "VolumeSize": "32",
                                                                                                                      "VolumeType": "gp2"
                                                                                                                    }
                                                                                                                  },
                                                                                                                  {
                                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                                    "VirtualName": "ephemeral0"
                                                                                                                  }
                                                                                                                ],
                                                                                                                {
                                                                                                                  "Fn::If": [
                                                                                                                    "is_r3_8xlarge",
                                                                                                                    [
                                                                                                                      {
                                                                                                                        "DeviceName": "/dev/sda1",
                                                                                                                        "Ebs": {
                                                                                                                          "DeleteOnTermination": "true",
                                                                                                                          "VolumeSize": "32",
                                                                                                                          "VolumeType": "gp2"
                                                                                                                        }
                                                                                                                      },
                                                                                                                      {
                                                                                                                        "DeviceName": "/dev/xvdb",
                                                                                                                        "VirtualName": "ephemeral0"
                                                                                                                      },
                                                                                                                      {
                                                                                                                        "DeviceName": "/dev/xvdc",
                                                                                                                        "VirtualName": "ephemeral1"
                                                                                                                      }
                                                                                                                    ],
                                                                                                                    {
                                                                                                                      "Fn::If": [
                                                                                                                        "is_d2_8xlarge",
                                                                                                                        [
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/sda1",
                                                                                                                            "Ebs": {
                                                                                                                              "DeleteOnTermination": "true",
                                                                                                                              "VolumeSize": "32",
                                                                                                                              "VolumeType": "gp2"
                                                                                                                            }
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdb",
                                                                                                                            "VirtualName": "ephemeral0"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdc",
                                                                                                                            "VirtualName": "ephemeral1"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdd",
                                                                                                                            "VirtualName": "ephemeral2"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvde",
                                                                                                                            "VirtualName": "ephemeral3"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdf",
                                                                                                                            "VirtualName": "ephemeral4"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdg",
                                                                                                                            "VirtualName": "ephemeral5"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdh",
                                                                                                                            "VirtualName": "ephemeral6"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdi",
                                                                                                                            "VirtualName": "ephemeral7"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdj",
                                                                                                                            "VirtualName": "ephemeral8"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdk",
                                                                                                                            "VirtualName": "ephemeral9"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdl",
                                                                                                                            "VirtualName": "ephemeral10"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdm",
                                                                                                                            "VirtualName": "ephemeral11"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdn",
                                                                                                                            "VirtualName": "ephemeral12"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdo",
                                                                                                                            "VirtualName": "ephemeral13"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdp",
                                                                                                                            "VirtualName": "ephemeral14"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdq",
                                                                                                                            "VirtualName": "ephemeral15"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdr",
                                                                                                                            "VirtualName": "ephemeral16"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvds",
                                                                                                                            "VirtualName": "ephemeral17"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdt",
                                                                                                                            "VirtualName": "ephemeral18"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdu",
                                                                                                                            "VirtualName": "ephemeral19"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdv",
                                                                                                                            "VirtualName": "ephemeral20"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdw",
                                                                                                                            "VirtualName": "ephemeral21"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdx",
                                                                                                                            "VirtualName": "ephemeral22"
                                                                                                                          },
                                                                                                                          {
                                                                                                                            "DeviceName": "/dev/xvdy",
                                                                                                                            "VirtualName": "ephemeral23"
                                                                                                                          }
                                                                                                                        ],
                                                                                                                        {
                                                                                                                          "Fn::If": [
                                                                                                                            "is_c1_medium",
                                                                                                                            [
                                                                                                                              {
                                                                                                                                "DeviceName": "/dev/sda1",
                                                                                                                                "Ebs": {
                                                                                                                                  "DeleteOnTermination": "true",
                                                                                                                                  "VolumeSize": "32",
                                                                                                                                  "VolumeType": "gp2"
                                                                                                                                }
                                                                                                                              },
                                                                                                                              {
                                                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                                                "VirtualName": "ephemeral0"
                                                                                                                              }
                                                                                                                            ],
                                                                                                                            {
                                                                                                                              "Fn::If": [
                                                                                                                                "is_m1_small",
                                                                                                                                [
                                                                                                                                  {
                                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                                    "Ebs": {
                                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                                      "VolumeSize": "32",
                                                                                                                                      "VolumeType": "gp2"
                                                                                                                                    }
                                                                                                                                  },
                                                                                                                                  {
                                                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                                                    "VirtualName": "ephemeral0"
                                                                                                                                  }
                                                                                                                                ],
                                                                                                                                {
                                                                                                                                  "Fn::If": [
                                                                                                                                    "is_d2_xlarge",
                                                                                                                                    [
                                                                                                                                      {
                                                                                                                                        "DeviceName": "/dev/sda1",
                                                                                                                                        "Ebs": {
                                                                                                                                          "DeleteOnTermination": "true",
                                                                                                                                          "VolumeSize": "32",
                                                                                                                                          "VolumeType": "gp2"
                                                                                                                                        }
                                                                                                                                      },
                                                                                                                                      {
                                                                                                                                        "DeviceName": "/dev/xvdb",
                                                                                                                                        "VirtualName": "ephemeral0"
                                                                                                                                      },
                                                                                                                                      {
                                                                                                                                        "DeviceName": "/dev/xvdc",
                                                                                                                                        "VirtualName": "ephemeral1"
                                                                                                                                      },
                                                                                                                                      {
                                                                                                                                        "DeviceName": "/dev/xvdd",
                                                                                                                                        "VirtualName": "ephemeral2"
                                                                                                                                      }
                                                                                                                                    ],
                                                                                                                                    {
                                                                                                                                      "Fn::If": [
                                                                                                                                        "is_r3_4xlarge",
                                                                                                                                        [
                                                                                                                                          {
                                                                                                                                            "DeviceName": "/dev/sda1",
                                                                                                                                            "Ebs": {
                                                                                                                                              "DeleteOnTermination": "true",
                                                                                                                                              "VolumeSize": "32",
                                                                                                                                              "VolumeType": "gp2"
                                                                                                                                            }
                                                                                                                                          },
                                                                                                                                          {
                                                                                                                                            "DeviceName": "/dev/xvdb",
                                                                                                                                            "VirtualName": "ephemeral0"
                                                                                                                                          }
                                                                                                                                        ],
                                                                                                                                        {
                                                                                                                                          "Fn::If": [
                                                                                                                                            "is_c1_xlarge",
                                                                                                                                            [
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/sda1",
                                                                                                                                                "Ebs": {
                                                                                                                                                  "DeleteOnTermination": "true",
                                                                                                                                                  "VolumeSize": "32",
                                                                                                                                                  "VolumeType": "gp2"
                                                                                                                                                }
                                                                                                                                              },
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                                                                "VirtualName": "ephemeral0"
                                                                                                                                              },
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/xvdc",
                                                                                                                                                "VirtualName": "ephemeral1"
                                                                                                                                              },
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/xvdd",
                                                                                                                                                "VirtualName": "ephemeral2"
                                                                                                                                              },
                                                                                                                                              {
                                                                                                                                                "DeviceName": "/dev/xvde",
                                                                                                                                                "VirtualName": "ephemeral3"
                                                                                                                                              }
                                                                                                                                            ],
                                                                                                                                            {
                                                                                                                                              "Fn::If": [
                                                                                                                                                "is_m3_2xlarge",
                                                                                                                                                [
                                                                                                                                                  {
                                                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                                                    "Ebs": {
                                                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                                                      "VolumeSize": "32",
                                                                                                                                                      "VolumeType": "gp2"
                                                                                                                                                    }
                                                                                                                                                  },
                                                                                                                                                  {
                                                                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                                                                    "VirtualName": "ephemeral0"
                                                                                                                                                  },
                                                                                                                                                  {
                                                                                                                                                    "DeviceName": "/dev/xvdc",
                                                                                                                                                    "VirtualName": "ephemeral1"
                                                                                                                                                  }
                                                                                                                                                ],
                                                                                                                                                {
                                                                                                                                                  "Fn::If": [
                                                                                                                                                    "is_cg1_4xlarge",
                                                                                                                                                    [
                                                                                                                                                      {
                                                                                                                                                        "DeviceName": "/dev/sda1",
                                                                                                                                                        "Ebs": {
                                                                                                                                                          "DeleteOnTermination": "true",
                                                                                                                                                          "VolumeSize": "32",
                                                                                                                                                          "VolumeType": "gp2"
                                                                                                                                                        }
                                                                                                                                                      },
                                                                                                                                                      {
                                                                                                                                                        "DeviceName": "/dev/xvdb",
                                                                                                                                                        "VirtualName": "ephemeral0"
                                                                                                                                                      },
                                                                                                                                                      {
                                                                                                                                                        "DeviceName": "/dev/xvdc",
                                                                                                                                                        "VirtualName": "ephemeral1"
                                                                                                                                                      }
                                                                                                                                                    ],
                                                                                                                                                    {
                                                                                                                                                      "Fn::If": [
                                                                                                                                                        "is_g2_8xlarge",
                                                                                                                                                        [
                                                                                                                                                          {
                                                                                                                                                            "DeviceName": "/dev/sda1",
                                                                                                                                                            "Ebs": {
                                                                                                                                                              "DeleteOnTermination": "true",
                                                                                                                                                              "VolumeSize": "32",
                                                                                                                                                              "VolumeType": "gp2"
                                                                                                                                                            }
                                                                                                                                                          },
                                                                                                                                                          {
                                                                                                                                                            "DeviceName": "/dev/xvdb",
                                                                                                                                                            "VirtualName": "ephemeral0"
                                                                                                                                                          },
                                                                                                                                                          {
                                                                                                                                                            "DeviceName": "/dev/xvdc",
                                                                                                                                                            "VirtualName": "ephemeral1"
                                                                                                                                                          }
                                                                                                                                                        ],
                                                                                                                                                        {
                                                                                                                                                          "Fn::If": [
                                                                                                                                                            "is_d2_2xlarge",
                                                                                                                                                            [
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/sda1",
                                                                                                                                                                "Ebs": {
                                                                                                                                                                  "DeleteOnTermination": "true",
                                                                                                                                                                  "VolumeSize": "32",
                                                                                                                                                                  "VolumeType": "gp2"
                                                                                                                                                                }
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdb",
                                                                                                                                                                "VirtualName": "ephemeral0"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdc",
                                                                                                                                                                "VirtualName": "ephemeral1"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdd",
                                                                                                                                                                "VirtualName": "ephemeral2"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvde",
                                                                                                                                                                "VirtualName": "ephemeral3"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdf",
                                                                                                                                                                "VirtualName": "ephemeral4"
                                                                                                                                                              },
                                                                                                                                                              {
                                                                                                                                                                "DeviceName": "/dev/xvdg",
                                                                                                                                                                "VirtualName": "ephemeral5"
                                                                                                                                                              }
                                                                                                                                                            ],
                                                                                                                                                            {
                                                                                                                                                              "Fn::If": [
                                                                                                                                                                "is_m3_large",
                                                                                                                                                                [
                                                                                                                                                                  {
                                                                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                                                                    "Ebs": {
                                                                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                                                                      "VolumeSize": "32",
                                                                                                                                                                      "VolumeType": "gp2"
                                                                                                                                                                    }
                                                                                                                                                                  },
                                                                                                                                                                  {
                                                                                                                                                                    "DeviceName": "/dev/xvdb",
                                                                                                                                                                    "VirtualName": "ephemeral0"
                                                                                                                                                                  }
                                                                                                                                                                ],
                                                                                                                                                                [
                                                                                                                                                                  {
                                                                                                                                                                    "DeviceName": "/dev/sda1",
                                                                                                                                                                    "Ebs": {
                                                                                                                                                                      "DeleteOnTermination": "true",
                                                                                                                                                                      "VolumeSize": "32",
                                                                                                                                                                      "VolumeType": "gp2"
                                                                                                                                                                    }
                                                                                                                                                                  }
                                                                                                                                                                ]
                                                                                                                                                              ]
                                                                                                                                                            }
                                                                                                                                                          ]
                                                                                                                                                        }
                                                                                                                                                      ]
                                                                                                                                                    }
                                                                                                                                                  ]
                                                                                                                                                }
                                                                                                                                              ]
                                                                                                                                            }
                                                                                                                                          ]
                                                                                                                                        }
                                                                                                                                      ]
                                                                                                                                    }
                                                                                                                                  ]
                                                                                                                                }
                                                                                                                              ]
                                                                                                                            }
                                                                                                                          ]
                                                                                                                        }
                                                                                                                      ]
                                                                                                                    }
                                                                                                                  ]
                                                                                                                }
                                                                                                              ]
                                                                                                            }
                                                                                                          ]
                                                                                                        }
                                                                                                      ]
                                                                                                    }
                                                                                                  ]
                                                                                                }
                                                                                              ]
                                                                                            }
                                                                                          ]
                                                                                        }
                                                                                      ]
                                                                                    }
                                                                                  ]
                                                                                }
                                                                              ]
                                                                            }
                                                                          ]
                                                                        }
                                                                      ]
                                                                    }
                                                                  ]
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      }
    }
  },
  "Outputs": {
    "InstanceId": {
      "Description": "InstanceId of the newly created EC2 instance",
      "Condition": "UsePlacementGroup",
      "Value": {
        "Ref": "EC2InstanceWithPlacementGroup"
      }
    },
    "InstanceId": {
      "Description": "InstanceId of the newly created EC2 instance",
      "Condition": "NotUsePlacementGroup",
      "Value": {
        "Ref": "EC2InstanceWithoutPlacementGroup"
      }
    },
    "AZ": {
      "Description": "Availability Zone of the newly created EC2 instance",
      "Condition": "UsePlacementGroup",
      "Value": {
        "Fn::GetAtt": [
          "EC2InstanceWithPlacementGroup",
          "AvailabilityZone"
        ]
      }
    },
    "AZ": {
      "Description": "Availability Zone of the newly created EC2 instance",
      "Condition": "NotUsePlacementGroup",
      "Value": {
        "Fn::GetAtt": [
          "EC2InstanceWithoutPlacementGroup",
          "AvailabilityZone"
        ]
      }
    },
    "PrivateDNS": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Condition": "UsePlacementGroup",
      "Value": {
        "Fn::GetAtt": [
          "EC2InstanceWithPlacementGroup",
          "PrivateDnsName"
        ]
      }
    },
    "PrivateDNS": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Condition": "NotUsePlacementGroup",
      "Value": {
        "Fn::GetAtt": [
          "EC2InstanceWithoutPlacementGroup",
          "PrivateDnsName"
        ]
      }
    },
    "PrivateIpAddress": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Condition": "UsePlacementGroup",
      "Value": {
        "Fn::GetAtt": ["EC2InstanceWithPlacementGroup", "PrivateIp"]
      }
    },
    "PrivateIpAddress": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Condition": "NotUsePlacementGroup",
      "Value": {
        "Fn::GetAtt": ["EC2InstanceWithoutPlacementGroup", "PrivateIp"]
      }
    }
  }
}